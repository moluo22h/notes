# ansibleåŸºç¡€-å˜é‡

æœ¬æ–‡è½¬è½½è‡ª[ansibleåŸºç¡€-å˜é‡](https://www.cnblogs.com/mauricewei/p/10054300.html)

## ä¸€ å˜é‡çš„å‘½åè§„èŒƒ

å˜é‡çš„å‘½ååº”è¯¥ç¬¦å¦‚ä¸‹åˆä¸¤ä¸ªè§„èŒƒï¼š

- å˜é‡åº”è¯¥ç”±`å­—æ¯`ã€`æ•°å­—`ã€`ä¸‹åˆ’çº¿`ç»„æˆ
- å˜é‡åº”è¯¥ä»¥å­—æ¯å¼€å¤´

ä¾‹å¦‚ï¼šhost_portã€HOST_PORTã€var5æ˜¯ç¬¦åˆå‘½åè§„èŒƒçš„ï¼Œfoo-portã€ foo portã€foo.port ã€12éƒ½ä¸ç¬¦åˆå‘½åè§„èŒƒã€‚

å˜é‡çš„å®šä¹‰é€šå¸¸æ˜¯YAMLå½¢å¼ï¼Œåœ¨inventory hostæ–‡ä»¶ä¸­ä¹Ÿå¯ä»¥ä½¿ç”¨INIå½¢å¼ã€‚

ansibleå˜é‡ä¸ä»…å¯ä»¥æ”¯æŒç®€å•çš„key=valueæ ¼å¼ï¼Œè€Œä¸”ä¹Ÿæ”¯æŒæ›´å¤æ‚æ•°æ®ç»“æ„ï¼Œä¾‹å¦‚å­—å…¸ç±»å‹ç­‰ã€‚

## äºŒ å˜é‡çš„ä½œç”¨åŸŸ

 å˜é‡çš„ä½œç”¨åŸŸå¯ä»¥åˆ†ä¸ºå››ç§ï¼š

- ä½œç”¨äºå…¨å±€çš„å˜é‡
- ä½œç”¨äºplayçš„å˜é‡
- ä½œç”¨äºtaskçš„å˜é‡
- ä½œç”¨äºhostçš„å˜é‡

æ¥ä¸‹æ¥æˆ‘ä»¬æ ¹æ®å˜é‡çš„ä½œç”¨åŸŸï¼Œè¯¦ç»†åˆ†æä¸‹ansibleå˜é‡çš„å®šä¹‰ã€ä½¿ç”¨å’Œè°ƒç”¨é¡ºåºã€‚

## ä¸‰ ä½œç”¨äºå…¨å±€çš„å˜é‡

### 3.1 é…ç½®æ–‡ä»¶å˜é‡

ansibleé…ç½®æ–‡ä»¶ä¼šå®šä¹‰ä¸€äº›å˜é‡ä¿¡æ¯ï¼Œä¸»è¦æ˜¯å¯¹æ‰§è¡Œç¯å¢ƒã€è¿æ¥ä¿¡æ¯å˜é‡çš„å®šä¹‰ã€‚

ä¾‹å¦‚inventoryç›®å½•ã€libraryç›®å½•ã€ä¸ç›®çš„ä¸»æœºè¿æ¥æ–¹å¼ã€è¶Šæƒä¿¡æ¯ã€è¿æ¥è¶…æ—¶æ—¶é—´ç­‰ç­‰ã€‚

### 3.2 ç³»ç»Ÿç¯å¢ƒå˜é‡

åœ¨ansibleè¿æ¥åˆ°ç›®çš„ä¸»æœºæ—¶ï¼Œä¼šä»¥`non-login shell`ç™»é™†åˆ°ç›®çš„ä¸»æœºï¼Œæ­¤æ—¶ç›®çš„ä¸»æœºçš„`/etc/bashrc`å’Œ`~/.basrc`çš„ç¯å¢ƒå˜é‡ä¼šè¢«åŠ è½½ï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªæ–‡ä»¶ä¸­è®¾ç½®çš„ç¯å¢ƒå˜é‡ä¼šä½œç”¨äºplaybookå…¨å±€ã€‚

### 3.3 å‘½ä»¤è¡Œå˜é‡

æˆ‘ä»¬å¯ä»¥åœ¨æ‰§è¡Œplaybookçš„å‘½ä»¤è¡ŒæŒ‡å®šå˜é‡ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ**å‘½ä»¤è¡ŒæŒ‡å®šçš„å˜é‡åœ¨æ‰€æœ‰å…¶ä»–å˜é‡ä¸­ä¼˜å…ˆçº§æ˜¯æœ€é«˜çš„ã€‚**ä¹Ÿå°±æ˜¯è¯´å¦‚æœå‘½ä»¤è¡ŒæŒ‡å®šçš„å˜é‡å’Œå…¶ä»–åœ°æ–¹æŒ‡å®šçš„å˜é‡æœ‰å†²çªæ—¶ï¼Œé‚£ä¹ˆansibleæœ€ç»ˆä¼šé‡‡ç”¨å‘½ä»¤è¡Œå®šä¹‰çš„å˜é‡ã€‚

å‘½ä»¤è¡ŒæŒ‡å®šå˜é‡ç¤ºä¾‹å¦‚ä¸‹ï¼š

```bash
$ ansible-playbook release.yml --extra-vars "version=1.23.45 other_variable=foo"
```

## å›› ä½œç”¨äºplayçš„å˜é‡

### 4.1 playbookä¸­çš„å˜é‡

#### 4.1.1 varsè¯­å¥å®šä¹‰å…¨å±€å˜é‡

æˆ‘ä»¬å¯ä»¥åœ¨playbookä¸­ä½¿ç”¨`vars`è¯­å¥å®šä¹‰å˜é‡ï¼Œè¯¥å˜é‡ä½œç”¨äºæ•´ä¸ªplayã€‚ä¾‹å¦‚ï¼š

inventory/playbooks/test.yaml

```yaml
- hosts: node1
  vars:
    http_port: 80
```

ä¸Šé¢ç¤ºä¾‹ä¸­ï¼Œ`http_port`æ˜¯ä¸€ä¸ªä½œç”¨äºæ•´ä¸ªplayçš„å˜é‡ï¼Œå¯¹è¿™ä¸ªplayé‡Œçš„tasksã€rolesã€importã€includeç­‰ç­‰ä¹‹ä¸‹å®šä¹‰çš„taskå‡ç”Ÿæ•ˆã€‚

#### 4.1.2 å¼•ç”¨å˜é‡æ–‡ä»¶

é™¤äº†å°†å˜é‡å†™åœ¨playbookä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å°†å˜é‡æ”¾åœ¨ä¸€ä¸ªå•ç‹¬çš„YAMLæ–‡ä»¶ä¸­ï¼Œé€šè¿‡`vars_files`è¯­å¥æ¥å¯¼å…¥ã€‚

`vars_files`å˜é‡åªèƒ½ä½œç”¨äºplayå…¨å±€ï¼Œä¸èƒ½åœ¨æŸä¸ªtaskä¸­å•ç‹¬è¢«å¼•ç”¨ã€‚`vars_files`å‚æ•°å¯ä»¥ä½¿ç”¨ç³»ç»Ÿç»å¯¹è·¯å¾„æˆ–playbookæ–‡ä»¶çš„ç›¸å¯¹è·¯å¾„ã€‚

ä¸¾ä¸ªğŸŒ°ï¼šæˆ‘ä»¬åœ¨playbooksç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª`vars-files.yaml`æ–‡ä»¶ï¼š

playbooks/vars-files.yaml

```yaml
age: 100
```

åœ¨playbookä¸­ä½¿ç”¨`vars_files`è¯­å¥å¼•ç”¨è¯¥å˜é‡æ–‡ä»¶ï¼š

playbooks/test.yaml

```yaml
- hosts: node1
  vars_files: ./vars-files.yaml
  tasks:
  - debug:
      msg: "My age is {{ age }}"
```

### 4.2 rolesä¸­çš„å˜é‡

#### 4.2.1 defaultå˜é‡

defaultå˜é‡ä½äº`roles/defaults/main.yml`æ–‡ä»¶ä¸­ï¼Œè¯¥å˜é‡ä½œç”¨äºroleé‡Œçš„æ‰€æœ‰playï¼Œé€šå¸¸ä½œä¸ºæ¨¡ç‰ˆæˆ–æ¨¡å—é‡Œçš„é»˜è®¤å‚æ•°ã€‚

defaultå˜é‡ä¸ansible filterå˜é‡ `{{ some_variable | default("some_value") }}`å…·æœ‰åŒæ ·çš„ä½œç”¨ï¼Œåœ¨æ‰€æœ‰ansibleå˜é‡ä¸­ä¼˜å…ˆçº§æœ€ä½ã€‚

#### 4.2.2 dependencieså˜é‡

dependencieså˜é‡ä½äº`roles/meta/main.yaml`æ–‡ä»¶ä¸­ï¼Œè¯¥å˜é‡ä¸`role`è¯­å¥åŒçº§ç¼©è¿›ï¼Œä½œç”¨äºæœ¬èº«çš„`role`å’Œ`dependencies role`ã€‚

ä¸¾ä¸ªğŸŒ°ï¼šrole_A å’Œ role_Bå®šä¹‰äº†ç›¸åŒçš„taskï¼Œdebugå‡º`age`å˜é‡ï¼š

```yaml
---
# tasks file for role_B
- debug:
    var: age
---
# tasks file for role_B
- debug:
    var: age
```

role_A/meta/main.yamlå®šä¹‰role_Aä¾èµ–role_Bï¼Œå¹¶æŒ‡å®šã€Œageã€å˜é‡ç­‰äº26ï¼š

```yaml
---
dependencies:
  - role: role_B
    vars:
      age: 27
```

å†™playbookï¼Œå¼•ç”¨role_Aï¼š

playbooks/test.yaml

```yaml
- hosts: node1
  roles:
    - role: role_A
```

æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š

```bash
âœ  lab-ansible ansible-playbook playbooks/test.yaml

PLAY [node1] ********************************************************************************************

TASK [Gathering Facts] **********************************************************************************
ok: [node1]

TASK [role_B : debug] ***********************************************************************************
ok: [node1] => {
    "age": 27
}

TASK [role_A : debug] ***********************************************************************************
ok: [node1] => {
    "age": 27
}

PLAY RECAP **********************************************************************************************
node1                      : ok=3    changed=0    unreachable=0    failed=0
```

è¾“å‡ºç»“æœæ˜¾ç¤ºï¼Œdependenciseå˜é‡ã€Œageã€åœ¨role_Aå’Œrole_Bå‡ç”Ÿæ•ˆã€‚

#### 4.2.3 varså˜é‡

varså˜é‡ä½äº`roles/vars/main.yml`ï¼Œè¯¥å˜é‡ä½œç”¨äºroleé‡Œçš„æ‰€æœ‰æ¨¡å—ã€‚é€šå¸¸å°†é™¤äº†é»˜è®¤å˜é‡çš„å…¶ä»–çš„å˜é‡æ”¾åœ¨è¿™ä¸ªæ–‡ä»¶å†…ã€‚

### 4.3 registerå˜é‡

registeræ–¹æ³•èƒ½å¤Ÿå°†ä¸€ä¸ªtaskçš„æ‰§è¡Œç»“æœæ³¨å†Œä¸ºä¸€ä¸ªå˜é‡ã€‚ä¹¦å†™æ ¼å¼è¦ä¸æ¨¡å—åç§°å¯¹é½ï¼Œè¯¥å˜é‡ä½œç”¨äºæ•´ä¸ªplayã€‚

é€šå¸¸registerå˜é‡å’Œwhenè¯­å¥è”åˆä½¿ç”¨ï¼Œä»¥è¾¾åˆ°æ»¡è¶³æŸäº›æ¡ä»¶æ‰è¿è¡Œtaskçš„ç›®çš„ã€‚

## äº” ä½œç”¨äºtaskçš„å˜é‡ 

### 5.1 playbookä¸­çš„å˜é‡

**with modules**

æˆ‘ä»¬å¯ä»¥ä¸ºæŸä¸ªæ¨¡å—å®šä¹‰å˜é‡ï¼Œè¯¥å˜é‡ä½œç”¨äºè¿™ä¸ªtaskã€‚

ä¸¾ä¸ªğŸŒ°ï¼Œç¤ºä¾‹ä¸­ä¸ºã€Œdebugã€æ¨¡å—å®šä¹‰äº†ã€Œnameã€å’Œã€Œageã€å˜é‡å¹¶åœ¨ã€Œmsgã€å‚æ•°åä½¿ç”¨äº†è¿™ä¸¤ä¸ªå˜é‡ï¼š

playbooks/test.yaml

```yaml
- hosts: node1
  tasks:
    - debug:
        msg: "My name is {{ name }} and I'm {{ age }} years old"
      vars:
        name: Maurice
        age: 27
```

**with import\*/include\***

åœ¨ä½¿ç”¨import_playbookã€import_tasksã€include_tasksã€import_roleã€include_roleæ—¶å¯ä»¥åœ¨import*/include*çš„åŒçº§ä½ç½®æŒ‡å®šå˜é‡ï¼Œè¯¥å˜é‡ä½œç”¨äºå¯¼å…¥çš„æ‰€æœ‰playã€‚

ä½¿ç”¨import_roleä¸¾ä¸ªğŸŒ°ï¼š

playbookå¯¼å…¥role_Aï¼Œå¹¶å®šä¹‰å˜é‡ã€Œageã€,è¿™æ ·role_Aå†…çš„playå°±å¯ä»¥ä½¿ç”¨ã€Œageã€å˜é‡äº†ï¼š

playbooks/test.yaml

```yaml
- hosts: node1
  tasks:
  - import_role:
      name: role_A
    vars:
      age: 1000
```

å…¶ä»–import*/include*çš„è¯­å¥ä½¿ç”¨æ–¹æ³•ç±»ä¼¼ï¼Œåªè¦è®°ä½**ç¼©è¿›ä¸import\*/include\*è¯­å¥ä¿æŒä¸€è‡´**å³å¯ã€‚

**with roles**

åœ¨playbookä¸­ä½¿ç”¨rolesè¯­å¥æ¥å¯¼å…¥roleæ—¶ä¹Ÿå¯ä»¥å®šä¹‰å˜é‡ï¼Œè¯¥å˜é‡ä½œç”¨äºroleåŒ…å«çš„æ‰€æœ‰playã€‚ 

ä¸¾ä¸ªğŸŒ°ï¼š

playbookä½¿ç”¨rolesè¯­å¥å¯¼å…¥role_Aï¼Œå¹¶å®šä¹‰å˜é‡ã€Œageã€ï¼š

 playbooks/test.yaml

```yaml
- hosts: node1
  roles:
    - role: role_A
      vars:
       age: 1000
```

é€šè¿‡ä¸Šé¢ä¸¤ä¸ªç¤ºä¾‹æˆ‘ä»¬å‘ç°ï¼Œroleså’Œimport_roleè¯­å¥å®šä¹‰å˜é‡å†™æ³•ä¸Šå¾ˆç›¸ä¼¼ï¼Œå…¶å®import_roleå’Œinclude_roleæ˜¯æ–°ç‰ˆæœ¬çš„è¯­æ³•ï¼ŒåŠŸèƒ½ä¸Šå®Œå…¨å¯ä»¥ä»£æ›¿rolesè¯­å¥ã€‚å¦‚æœä½ ä½¿ç”¨çš„ansibleç‰ˆæœ¬>=2.4ï¼Œå»ºè®®**ä½¿ç”¨include_roleå’Œimport_role**è¯­å¥ã€‚

### 5.2 rolesä¸­çš„å˜é‡

æŒ‡çš„æ˜¯åœ¨tasks/main.yamlæˆ–handlers/main.yamlå†…ä¹¦å†™taskæ—¶æŒ‡å®šçš„å˜é‡ï¼Œè¯¥å˜é‡ä½œç”¨äºæŸä¸ªtaskï¼Œè¿™ä¸ªå˜é‡ç±»å‹å’Œä¸Šè¿°ç« èŠ‚ä¸­ã€Œ5.1playbookä¸­çš„å˜é‡â€”with modulesã€ç±»ä¼¼ï¼Œè¿™é‡Œå°±ä¸å†ä¸¾ä¾‹è¯´æ˜ã€‚

## å…­ ä½œç”¨äºhostçš„å˜é‡

### **6.1 ç³»ç»Ÿå˜é‡Facts**

#### **6.1.1 factså˜é‡**

ansibleä¸­æœ‰ä¸ªç‰¹æ®Šçš„å˜é‡ï¼Œè¿™äº›å˜é‡ä¸æ˜¯å¼€å‘è€…å®šä¹‰çš„ï¼Œè€Œæ˜¯ansibleæ ¹æ®ç›®çš„ä¸»æœºç¯å¢ƒä¿¡æ¯è‡ªåŠ¨æ”¶é›†çš„ï¼Œç§°ä¹‹ä¸ºfactå˜é‡ã€‚

factå˜é‡å¾ˆå®ç”¨ï¼Œå’Œã€Œwhenã€è¯­å¥é…åˆä½¿ç”¨ä¼šè®©ä½ çš„ä»£ç æ›´åŠ å¥å£®ã€‚

ä¸¾ä¸ªğŸŒ°ï¼Œå¦‚æœå½“å‰çš„æ“ä½œç³»ç»Ÿä¸ºã€ŒRedHatã€ç±»å‹ï¼Œåˆ™é€šè¿‡yumå®‰è£…éœ€è¦çš„è½¯ä»¶åŒ…ï¼š

playbooks/test.yaml

```yaml
- hosts: node1
  tasks:
    - yum:
        name: firewalld
        state: present
      when: ansible_os_family == 'RedHat'
```

#### **6.1.2 factsç¼“å­˜**

åœ¨æ‰§è¡Œplaybookæ—¶ï¼Œæˆ‘ä»¬å‘ç°åœ¨ã€ŒGathering Factsã€æ­¥éª¤æ—¶æ€»ä¼šå¡ä½ä¸€ä¼šï¼Œå¦‚æœå®šä¹‰çš„playå¤šäº†ï¼Œä¼šéå¸¸è€—æ—¶ã€‚å…¶å®è¿™æ­¥å°±æ˜¯ansibleåœ¨æ”¶é›†ç›®çš„ä¸»æœºçš„factsä¿¡æ¯ã€‚

å¦‚æœæˆ‘ä»¬å®šä¹‰çš„playbookä¸­å¹¶æ²¡æœ‰ä½¿ç”¨åˆ°factå˜é‡ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€‰æ‹©å°†å…¶å…³é—­ï¼Œåªéœ€æ·»åŠ ã€Œgather_facts: falseã€å³å¯ã€‚

å¦‚æœå¿…é¡»è¦ä½¿ç”¨factsä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥å°†factä¿¡æ¯ç¼“å­˜åˆ°redisæœåŠ¡æˆ–æœ¬åœ°jsonæ–‡ä»¶ä¸­ï¼Œè¿™æ ·å½“æˆ‘ä»¬ç¬¬äºŒæ¬¡æ‰§è¡Œplaybookæ—¶ï¼Œansibleå°±ä¼šè¯»å–ç¼“å­˜ä¿¡æ¯ï¼Œä»è€ŒåŠ å¿«è¿è¡Œé€Ÿåº¦ã€‚

å‡è®¾æœ¬åœ°redisæœåŠ¡æ­£å¸¸è¿è¡Œï¼Œæˆ‘ä»¬åªéœ€æ›´æ”¹ansibleé…ç½®æ–‡ä»¶å³å¯è¾¾åˆ°ç¼“å­˜factçš„ç›®çš„ã€‚

redisç¼“å­˜ï¼š

```ini
[defaults]
gathering = smart
fact_caching = redis
fact_caching_timeout = 86400
```

jsonæ–‡ä»¶ç¼“å­˜ï¼š

```ini
[defaults]
gathering = smart
fact_caching = jsonfile
fact_caching_connection = /path/to/cachedir
fact_caching_timeout = 86400
```

### 6.2 inventoryä¸­çš„å˜é‡

#### 6.2.1 ä¸»æœºå˜é‡

å…³äºä¸»æœºå’Œä¸»æœºç»„å˜é‡ï¼Œæˆ‘ä»¬åœ¨ã€Œ[ansibleåŸºç¡€-å®‰è£…ä¸é…ç½®](https://mp.weixin.qq.com/s?__biz=MzUzMDc0MjgwNg==&mid=2247483677&idx=1&sn=23a267d67f3cf46aa29cf94fa16c76fe&scene=21#wechat_redirect)ï¼š3.1 ä¸»æœºä¸ä¸»æœºç»„ã€ä¸­æœ‰ä»‹ç»ï¼Œå½“æ—¶ä»‹ç»äº†ç»„å’Œä¸»æœºå˜é‡çš„å®šä¹‰æ–¹æ³•ã€å˜é‡çš„åˆ†ç¦»ã€ä¼˜å…ˆçº§ç­‰çŸ¥è¯†ç‚¹ã€‚å…¶å®ä¸»æœºå˜é‡çš„çŸ¥è¯†ç‚¹ä¸å¤æ‚ï¼Œè¿™é‡Œåšä¸‹æ€»ç»“ã€‚ä¸»æœºå˜é‡æ˜¯æŒ‡ä½œç”¨åœ¨æŸä¸€å°ä¸»æœºä¸Šçš„å˜é‡ã€‚ä½ç½®å¯ä»¥ä¸ä¸»æœºå®šä¹‰å†™åœ¨ä¸€èµ·ä¹Ÿå¯ä»¥å†™åœ¨inventory/host_vars/a_host_name.yamlæ–‡ä»¶é‡Œã€‚é€šå¸¸å‰è€…ä½¿ç”¨ä½¿ç”¨INIæ ¼å¼ï¼Œåè€…ä½¿ç”¨YAMLæ ¼å¼ã€‚è¿™é‡Œè¦æ³¨æ„ä¸€ä¸‹YAMLçš„è¯­æ³•ï¼Œåœ¨ã€Œ:ã€åé¢è¦ç•™æœ‰ä¸€ä¸ªç©ºæ ¼ã€‚å¦‚æœç»„å˜é‡å’Œä¸»æœºå˜é‡éƒ½å¯¹åŒä¸€ä¸ªä¸»æœºå®šä¹‰äº†ç›¸åŒçš„å˜é‡ï¼Œé‚£ä¹ˆ**ansibleæœ€ç»ˆä¼šé‡‡ç”¨ä¸»æœºå˜é‡è€Œæ”¾å¼ƒç»„å˜é‡**ã€‚ä¸»æœºå˜é‡ç¤ºä¾‹ï¼šINIæ ¼å¼ï¼š

inventory/hosts

```ini
[nodes]
node1
node2
node3
[nodes:vars]
http_port=80
database_port=3306
```

è½¬æ¢ä¸ºYAMLæ ¼å¼ï¼š

inventory/hosts

```ini
nodes:
  hosts:
    node1:
    node2:
    node3:
  vars:
    http_port: \'80\'
    database_port: \'3306\'
```

ä¸å«èŠ‚ç‚¹å®šä¹‰çš„ä¸»æœºå˜é‡å®šä¹‰ï¼š

inventory/host_vars/node1.yaml

```ini
http_port: \'80\'
database_port: \'3306\'
```

#### **6.2.2 ç»„å˜é‡** 

å’Œä¸»æœºå˜é‡ç±»ä¼¼ï¼Œç»„å˜é‡ä½œç”¨äºä¸»æœºç»„ï¼Œå³å¤šä¸ªä¸»æœºã€‚ä½ç½®å¯ä»¥ä¸ä¸»æœºç»„å®šä¹‰å†™åœ¨ä¸€èµ·ä¹Ÿå¯ä»¥å†™åœ¨inventory/group_vars/a_group_name.yamlæ–‡ä»¶é‡Œã€‚é€šå¸¸å‰è€…ä½¿ç”¨ä½¿ç”¨INIæ ¼å¼ï¼Œåè€…ä½¿ç”¨YAMLæ ¼å¼ã€‚

INIæ ¼å¼ï¼š

inventory/hosts

```ini
[nodes]
node1
node2
node3
[nodes:vars]
http_port=80
database_port=3306
```

è½¬æ¢ä¸ºYAMLæ ¼å¼ï¼š

inventory/hosts

```ini
nodes:
  hosts:
    node1:
    node2:
    node3:
  vars:
    http_port: \'80\'
    database_port: \'3306\'
```

å®šä¹‰ä¸€ä¸ªå­—å…¸å˜é‡ï¼Œä½äºinventory/group_vars/nodes.yamlï¼š

```yaml
---
# ä¸€ä½èŒå·¥è®°å½•
name: Maurice
job: Developer
skill: Develop program
employed: True
foods:
    - Apple
    - Orange
languages:
    shell: Elite
    python: Elite
    c++: Lame
```

å°†ä¸Šé¢ç¤ºä¾‹è½¬æ¢ä¸ºä¸€è¡Œï¼š

```json
---
# ä¸€ä½èŒå·¥è®°å½•
{name: Maurice,job: Developer,skill: Develop program,employed: True,foods: [\'Apple\',\'Orange\'],languages: {shell: Elite,python: Elite,c++: Lame}}
```

å¾ˆæ˜¾ç„¶ï¼ŒYANLæ ¼å¼åˆ†è¡Œæ¥å†™ä¼šæ›´åŠ ç›´è§‚å’Œç¾è§‚ã€‚

## ä¸ƒ å˜é‡çš„è°ƒç”¨é¡ºåº

é€šè¿‡ä¸Šé¢æè¿°ï¼Œæˆ‘ä»¬å‘ç°ansibleèƒ½å¤Ÿå®šä¹‰å˜é‡çš„åœ°æ–¹çœŸçš„æ˜¯å¤ªå¤šå¤ªå¤šäº†ï¼Œæˆ‘ä¸ªäººè§‰å¾—ansibleå˜é‡è¿™å—çš„è®¾è®¡æœ‰ç‚¹å¤æ‚å’Œå†—ä½™ã€‚

åœ¨ç”Ÿäº§ä¸­ï¼Œæˆ‘ä»¬è¦è¯»æ‡‚åˆ«äººçš„ä»£ç æˆ–è€…è®©è‡ªå·±çš„ä»£ç æ›´åŠ å¥å£®ï¼Œå°±å¿…é¡»æ¸…æ¥šçš„çŸ¥é“ansibleæœ€ç»ˆä¼šä½¿ç”¨å“ªä¸ªå˜é‡ã€‚è¿™é‡Œæˆ‘æ€»ç»“ä¸‹ansibleçš„è°ƒç”¨å˜é‡çš„é¡ºåºï¼Œå½“å°ä¼™ä¼´è¿·èŒ«æ—¶å¯ä»¥å›æ¥çœ‹ä¸‹è¿™ä¸ªåˆ—è¡¨ï¼ˆè¶Šé åå˜é‡ä¼˜å…ˆçº§è¶Šé«˜ï¼Œè¶Šä¼šè¢«ansibleé‡‡ç”¨ï¼‰

- å‘½ä»¤è¡Œå‚æ•°ï¼ˆé-eæŒ‡å®šçš„å‚æ•°ï¼Œeg: "-u user -b yes"ï¼‰
- roles defaultsç›®å½•ä¸‹çš„å˜é‡
- ç»„å˜é‡ï¼šinventory æ–‡ä»¶
- ç»„å˜é‡ï¼šinventory/group_vars/all
- ç»„å˜é‡ï¼šplaybook/group_vars/all
- ç»„å˜é‡ï¼šinventory/group_vars/*
- ç»„å˜é‡ï¼šplaybook/group_vars/*
- ä¸»æœºå˜é‡ï¼šinventory æ–‡ä»¶
- ä¸»æœºå˜é‡ï¼šinventory/group_vars/*
- ä¸»æœºå˜é‡ï¼šplaybook/group_vars/*
- factså˜é‡
- playå˜é‡ï¼švarså®šä¹‰çš„
- playå˜é‡ï¼švars_promptå®šä¹‰çš„
- playå˜é‡ï¼švars_fileså¯¼å…¥çš„
- roles varsç›®å½•ä¸‹çš„å˜é‡
- blockä¸­taskå®šä¹‰çš„å˜é‡
- playbookä¸­taskå®šä¹‰çš„å˜é‡
- include_varså¯¼å…¥çš„å˜é‡
- set_facts/registeræ³¨å†Œçš„å˜é‡
- ä½¿ç”¨roles/include_role/import_roleè¯­å¥æ—¶å®šä¹‰çš„å˜é‡
- ä½¿ç”¨includeè¯­å¥ï¼ˆansibleæ—§ç‰ˆæœ¬ï¼‰æ—¶å®šä¹‰çš„å˜é‡
- å‘½ä»¤è¡Œ-eå‚æ•°æŒ‡å®šçš„é¢å¤–å˜é‡ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰

## å…« å˜é‡çš„ä½¿ç”¨

### 8.1 æ¨¡å—ä½¿ç”¨å˜é‡

ä¸€ä¸ªå˜é‡è¢«å®šä¹‰åï¼Œåœ¨å®ƒçš„ä½œç”¨åŸŸå†…çš„playå¯ä»¥ç›´æ¥è°ƒç”¨ï¼Œä¾‹å¦‚ï¼š

æˆ‘ä»¬å®šä¹‰äº†æ•´ä¸ªplayä½œç”¨åŸŸçš„å˜é‡ã€Œnameã€å’Œã€Œageã€ï¼Œé‚£ä¹ˆåœ¨ä¹‹åçš„ä¸¤ä¸ªdebugæ¨¡å—å†…å¯ä»¥ç›´æ¥è°ƒç”¨ã€‚

playbooks/test.yaml

```yaml
- hosts: node1
  vars:
    name: Maurice
    age: 27
  tasks:
    - debug:
        msg: "My name is {{ name }} and I'm {{ age }} years old"
    - debug:
        msg: "Hello Maurice"
      when: name == 'Maurice'
```

è¾“å‡ºç»“æœå±•ç¤ºï¼š

```bash
âœ  lab-ansible ansible-playbook playbooks/test.yaml


PLAY [node1] ********************************************************************************************

TASK [Gathering Facts] **********************************************************************************
ok: [node1]

TASK [debug] ********************************************************************************************
ok: [node1] => {
    "msg": "My name is Maurice and I'm 27 years old"
}

TASK [debug] ********************************************************************************************
ok: [node1] => {
    "msg": "Hello Maurice"
}

PLAY RECAP **********************************************************************************************
node1                      : ok=3    changed=0    unreachable=0    failed=0
```

### 8.2 æ¨¡ç‰ˆä½¿ç”¨å˜é‡

å˜é‡è¢«é¢‘ç¹ä½¿ç”¨çš„è¿˜æœ‰rolesé‡Œçš„æ¨¡ç‰ˆï¼Œä½äºroles/template/xxx.j2ï¼Œè¯¥æ¨¡ç‰ˆä½¿ç”¨pythonçš„Jinja2æ¨¡ç‰ˆè¯­æ³•ã€‚

rolesæ¨¡ç‰ˆå¤šè¢«ç”¨äºç”ŸæˆæœåŠ¡çš„é…ç½®æ–‡ä»¶ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨å¾ˆå¤šçš„å˜é‡ã€‚

ç¤ºä¾‹å¦‚ä¸‹ï¼š

```jinja2
  "customerMonthInfo": "{{ cmp_server_customerMonthInfo }}",
  "type_black_list": [{% for type_black in cmp_server_type_black_list %}"{{ type_black }}"{{ '' if loop.last else ',' }}{% endfor %}],
```

ä¸Šè¿°ç¤ºä¾‹ä¸­ã€ŒcustomerMonthInfoã€çš„å‚æ•°æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å˜é‡ã€Œcmp_server_customerMonthInfoã€çš„å€¼

ã€Œtype_black_listã€å‚æ•°ä»åˆ—è¡¨å˜é‡ã€Œcmp_server_type_black_listã€ä¸­è·å–ï¼Œæ‰§è¡Œç»“æœæ˜¯ä¸ªå­—ç¬¦ä¸²ï¼Œå­—ç¬¦ä¸²ç”±è¯¥åˆ—è¡¨çš„å…ƒç´ ä»¥é€—å·ä¸ºé—´éš”ç»„æˆï¼Œæœ€åä¸€ä¸ªå‚æ•°åæ²¡æœ‰é€—å·ã€‚

## ä¹ æœ¬èŠ‚åº”è¯¥æŒæ¡çš„æŠ€èƒ½

- æŒæ¡å˜é‡çš„å‘½åè§„èŒƒ
- æŒæ¡å˜é‡å®šä¹‰çš„æ–¹æ³•
- æŒæ¡å˜é‡çš„ä½œç”¨åŸŸåŠè°ƒç”¨é¡ºåº
- ä¼šåœ¨æ¨¡å—å’Œæ¨¡ç‰ˆé‡Œä½¿ç”¨å˜é‡
- ç†Ÿæ‚‰Jinja2æ¨¡ç‰ˆçš„è¯­æ³•è§„åˆ™

## å å‚è€ƒé“¾æ¥

- https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html#passing-variables-on-the-command-line
- https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse_roles.html
- https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html
- çº¢å¸½DO407 Automation with Ansible æ•™æ